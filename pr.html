---
---

<!doctype html>
<html lang="en" style="height: 100%; width: 100%;">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
</head>

<body style="height: 100%; width: 100%; margin: 0;">
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <script>
    var proxyUrl = "https://prhero-proxy.colinjfw.workers.dev";
    var appUrl = "https://prhero.github.io/prhero/";
    var apiUrl = proxyUrl + "/api";
    var loginUrl = proxyUrl + "/login?return={{jekyll.environment}}";

    function isAuthenticated() {
      if (getToken()) {
        return;
      }
      var token = localStorage.getItem("prhero-token");
      if (!token) {
        return Promise.reject();
      }
      return Promise.resolve(token);
    }

    function checkAuth(token) {
      var url = proxyUrl + "/api/user";
      return fetch(url, { headers: { authorization: "token " + token }})
        .then(function (res) {
          if (res.status !== 200) throw new Error("Unauthenticated");
        });
    }

    function saveParams() {
      var params = new URLSearchParams(window.location.search);
      sessionStorage.setItem("owner", params.get("owner") || "");
      sessionStorage.setItem("repo", params.get("repo") || "");
      sessionStorage.setItem("pr", params.get("pr") || "");
    }

    function getToken() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get("token");

      if (token) {
        localStorage.setItem("prhero-token", token);
        window.location.href = "/pr?" +
          "&owner=" + (sessionStorage.getItem("owner") || "") +
          "&repo=" + (sessionStorage.getItem("repo") || "") +
          "&pr=" + (sessionStorage.getItem("pr") || "");
        return true;
      }
      return false;
    }

    function startApp(token) {
      var params = new URLSearchParams(window.location.search);

      var iframe = document.createElement("iframe");
      iframe.frameBorder = "0";
      iframe.width = "100%";
      iframe.height = "100%";
      iframe.style = "margin: 0; padding: 0;";
      iframe.src = appUrl +
        "?token=" + encodeURIComponent(token) +
        "&url=" + encodeURIComponent(apiUrl) +
        "&owner=" + (params.get("owner") || "") +
        "&repo=" + (params.get("repo") || "")+
        "&pr=" + (params.get("pr") || "");
      document.body.append(iframe);
    }

    (function () {
      isAuthenticated()
        .then(function (token) {
          startApp(token);
          return checkAuth(token);
        })
        .catch(function() {
          saveParams();
          window.location.href = loginUrl;
        });
    })();
  </script>

</body>
</html>
